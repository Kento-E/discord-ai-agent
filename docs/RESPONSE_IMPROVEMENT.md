# 応答生成機能の改善について

## 概要

このドキュメントでは、エージェントの応答生成ロジックの改善内容について説明します。

## 問題点

以前の実装では、質問に対しても通常会話に対しても、常に最初の類似メッセージ（単文）をそのまま返すだけでした。

### 旧実装の問題

```python
# 質問への応答
if is_question:
    base_message = similar_messages[0]  # 単文のみ
    response = apply_common_ending(base_message, common_endings)
    return response
```

**結果**: 「Pythonのインストール方法を教えて」→「公式サイトからダウンロードできます。」（短すぎる）

## 改善内容

### 1. 質問への詳細回答

質問に対しては、複数の類似メッセージを組み合わせて詳細な助言を生成するようになりました。

```python
def generate_detailed_answer(similar_messages, persona):
    """
    質問に対して、複数の類似メッセージを組み合わせた詳細な回答を生成
    
    特徴:
    - 複数のメッセージから文を抽出
    - 重複を避けながら組み合わせ
    - 最低100文字または平均メッセージ長の3倍を目標
    - 各文を改行で区切って複数行の回答を構築
    """
```

**新しい応答例**:

```
質問: Pythonのインストール方法を教えてください

応答:
Pythonのインストールは公式サイトからできます。
ダウンロードページで自分のOSを選んでください。
インストーラーを実行すればOKです。
PATH設定を忘れずにチェックしてください。
```

### 2. 通常会話への自然な応答

通常会話に対しては、ペルソナに沿った短めの受け答えを生成します。

```python
def generate_casual_response(similar_messages, persona):
    """
    通常会話に対して、ペルソナに沿った短めの受け答えを生成
    
    特徴:
    - ペルソナの平均メッセージ長に基づいて長さを調整
    - 長すぎる場合は最初の文のみ（短縮）
    - 短すぎる場合は2つ目のメッセージも組み合わせ（拡張）
    """
```

**応答例**:

```
入力: 今日はいい天気ですね
応答: そうですね。お散歩日和です。

入力: 頑張りましょう
応答: はい、一緒に頑張りましょう！
```

### 3. 質問検出の強化

質問をより正確に検出できるよう、キーワードを追加しました。

**追加キーワード**:
- 「どのように」
- 「なぜ」
- 「教えて」
- 「方法」
- 「やり方」

## 動作フロー

```
ユーザー入力
    ↓
質問検出
    ↓
[質問の場合]
    ↓
generate_detailed_answer()
    ↓
複数の類似メッセージから文を抽出
    ↓
重複を避けながら組み合わせ
    ↓
詳細な回答を生成（複数行）
    ↓
ペルソナの文末表現を適用

[通常会話の場合]
    ↓
generate_casual_response()
    ↓
ペルソナの平均長に基づいて調整
    ↓
短めの受け答えを生成
    ↓
ペルソナの文末表現を適用
```

## 技術的な詳細

### 重複除去ロジック

詳細回答の生成時、類似度60%以上の文は重複とみなして除外します：

```python
for used in used_sentences:
    if len(sentence) > 0 and len(used) > 0:
        common_chars = sum(1 for c in sentence if c in used)
        similarity = common_chars / max(len(sentence), len(used))
        if similarity > 0.6:
            is_duplicate = True
            break
```

### 長さ調整ロジック

通常会話では、ペルソナの平均メッセージ長に基づいて自動調整：

- **長すぎる場合** (平均の1.5倍以上): 最初の文のみを使用
- **短すぎる場合** (平均の0.5倍以下): 2つ目の類似メッセージも追加
- **適切な長さ**: そのまま使用

## テスト

新しい機能は以下のテストでカバーされています：

1. **単体テスト** (`test_response_functions.py`)
   - 詳細回答生成のテスト
   - カジュアル応答生成のテスト
   - 質問検出ロジックのテスト

2. **統合テスト** (`test_new_response.py`)
   - 実際のモデルを使った応答生成テスト（実環境用）

3. **既存テスト**
   - すべての既存テストが引き続き合格

## まとめ

この改善により、エージェントは以下のように動作するようになりました：

✅ **質問への応答**: 複数の類似メッセージを組み合わせて、数行〜十数行の詳細な助言を提供

✅ **通常会話への応答**: ペルソナに沿った短めの自然な受け答えを提供

✅ **質問検出**: より多くのパターンで質問を正確に検出
