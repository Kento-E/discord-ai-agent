# 知識データ生成30分タイムアウト問題の調査報告

## 問題の概要

[GitHub Actions実行ログ](https://github.com/Kento-E/discord-ai-agent/actions/runs/19463649432/job/55693520528)において、知識データ生成ワークフローが30分超過でキャンセルされました。

## 原因の詳細

### 1. タイムアウト設定

ワークフローファイル `.github/workflows/generate-knowledge-data.yml` の19行目に以下の設定があります：

```yaml
timeout-minutes: 30
```

この設定により、ジョブ全体が30分を超えると自動的にキャンセルされます。

### 2. 実行時間の内訳

実行ログから各ステップの処理時間を分析しました：

| ステップ | 開始時刻 (UTC) | 終了時刻 (UTC) | 所要時間 | 備考 |
|---------|---------------|---------------|----------|------|
| セットアップ系 | 10:58:17 | 11:02:07 | 約3分50秒 | Python環境、依存関係のインストール |
| メッセージを取得 | 11:02:07 | 11:14:35 | **約12分30秒** | Discord APIからのメッセージ取得 |
| 埋め込みデータを生成 | 11:14:35 | 11:27:41 | **約13分** | Sentence Transformerによる埋め込み生成 |
| 知識データを暗号化 | 11:27:41 | 11:28:15 | 約34秒 | 242MBのファイルを圧縮・暗号化 |
| アーティファクトをアップロード | 11:28:15 | 11:28:17 (中断) | 約2秒 (未完了) | **タイムアウトによりキャンセル** |

**合計実行時間**: 約30分3秒

### 3. タイムアウトの発生箇所

- ジョブ開始: 10:58:17 UTC
- ジョブキャンセル: 11:28:20 UTC
- 経過時間: **30分3秒**

アーティファクトのアップロード中（167MB/242MBアップロード完了時点）にタイムアウトが発生し、以下のエラーメッセージが出力されました：

```
##[error]The operation was canceled.
```

## 問題の本質

1. **処理が重い2つのステップ**:
   - メッセージ取得: 約12.5分
   - 埋め込みデータ生成: 約13分
   - これらだけで**合計25.5分**を消費

2. **セットアップのオーバーヘッド**: 約3分50秒

3. **バッファ不足**: 30分の制限に対して、実際に必要な時間が30分超となり、アーティファクトアップロードの時間が確保できていない

## 解決策の提案

### 推奨: タイムアウト時間の延長

最もシンプルで効果的な解決策は、ワークフローのタイムアウト時間を延長することです。

```yaml
timeout-minutes: 60  # 30分から60分に変更
```

**理由**:
- 現在の処理は正常に動作している（エラーではなくタイムアウト）
- データ量や処理内容に問題はない
- 余裕を持った時間設定により、将来的なデータ増加にも対応可能

### その他の検討可能な対策

#### 1. 埋め込みモデルの最適化

現在使用している`all-MiniLM-L6-v2`は軽量モデルですが、さらに高速化する方法：

- バッチサイズの調整
- GPUの利用（GitHub ActionsでGPUランナーを使用する場合は追加コストが発生）

#### 2. 段階的な実行

ワークフローを複数のジョブに分割：

1. メッセージ取得ジョブ（タイムアウト: 20分）
2. 埋め込み生成ジョブ（タイムアウト: 20分）
3. 暗号化・アップロードジョブ（タイムアウト: 10分）

**デメリット**: ワークフローが複雑化し、ジョブ間のアーティファクト受け渡しに時間がかかる

#### 3. キャッシュの活用

メッセージデータや中間ファイルをキャッシュして、再実行時の時間を短縮。

**デメリット**: 初回実行や完全な更新時には効果がない

## 推奨する対応

### Step 1: タイムアウト時間を60分に変更

`.github/workflows/generate-knowledge-data.yml` の19行目を以下のように変更：

```yaml
# 変更前
timeout-minutes: 30

# 変更後
timeout-minutes: 60  # データ量の増加を考慮して余裕を持った設定
```

### Step 2: ドキュメントの更新

ワークフローの想定実行時間をドキュメントに記載し、ユーザーに期待値を伝える。

## まとめ

知識データ生成が30分超過でエラーになる原因は、**ワークフローのタイムアウト設定（30分）が、実際の処理時間（約30分以上）に対して不足しているため**です。

最も効果的な解決策は、**タイムアウト時間を60分に延長すること**です。これにより：

- 現在の処理が正常に完了する
- 将来的なデータ量増加にも対応できる
- シンプルで保守性が高い

処理自体には問題がなく、単純に時間の余裕を持たせることで解決できる問題です。
